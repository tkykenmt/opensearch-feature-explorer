---
tags:
  - opensearch
---
# Template Query

## Summary

The Template Query is a specialized query type in OpenSearch that enables dynamic placeholder substitution in search queries. It allows queries to contain variables using the `"${variable_name}"` syntax that are resolved at runtime by search request processors. This is particularly useful for AI/ML workflows where query parameters need to be generated dynamically, such as converting text to vector embeddings.

## Details

### Architecture

```mermaid
flowchart TB
    subgraph "Query Processing Pipeline"
        A[Initial Search Request] --> B[Search Request Processors]
        B --> C["PipelineProcessingContext\n(stores generated values)"]
        C --> D[Query Rewrite Phase]
        D --> E["QueryCoordinatorContext\n(provides context variables)"]
        E --> F[Template Variable Resolution]
        F --> G[Final Query Execution]
    end
    
    subgraph "Template Query Example"
        H["{ template: { knn: { vector: \"${embedding}\" } } }"]
    end
    
    H --> A
```

### Components

| Component | Description |
|-----------|-------------|
| `TemplateQueryBuilder` | Query builder that holds template content with placeholder variables |
| `QueryRewriteContext` | Interface defining the contract for query rewrite contexts |
| `BaseQueryRewriteContext` | Base implementation providing core rewrite functionality |
| `QueryCoordinatorContext` | Coordinator-level context that provides access to pipeline variables |
| `PipelineProcessingContext` | Stores attributes generated by search request processors |

### Configuration

Template queries require a search pipeline with processors that generate the placeholder values:

```json
PUT /_search/pipeline/my_pipeline
{
  "request_processors": [
    {
      "ml_inference": {
        "model_id": "<model_id>",
        "input_map": [
          { "inputText": "ext.ml_inference.text" }
        ],
        "output_map": [
          { "text_embedding": "embedding" }
        ]
      }
    }
  ]
}
```

### Usage Examples

#### k-NN Vector Search with ML Inference

```json
GET /my-index/_search?search_pipeline=my_pipeline
{
  "query": {
    "template": {
      "knn": {
        "text_embedding": {
          "vector": "${text_embedding}",
          "k": 10
        }
      }
    }
  },
  "ext": {
    "ml_inference": {
      "text": "semantic search query"
    }
  }
}
```

#### Terms Query with Dynamic Values

```json
{
  "query": {
    "template": {
      "terms": {
        "category": "${categories}"
      }
    }
  }
}
```

#### Range Query with Dynamic Bounds

```json
{
  "query": {
    "template": {
      "range": {
        "price": {
          "gte": "${min_price}",
          "lte": "${max_price}"
        }
      }
    }
  }
}
```

#### Boolean Query with Multiple Placeholders

```json
{
  "query": {
    "template": {
      "bool": {
        "must": [
          { "match": { "content": "${keyword}" } }
        ],
        "filter": [
          { "term": { "status": "active" } }
        ]
      }
    }
  }
}
```

### Variable Resolution Process

1. Template content is serialized to JSON string
2. Context variables from `PipelineProcessingContext` are retrieved
3. Each variable is converted to proper JSON representation
4. Placeholders (`"${var}"`) are replaced with JSON values
5. Resulting JSON is parsed into the appropriate QueryBuilder

### Supported Variable Types

| Type | JSON Representation | Example |
|------|--------------------|---------| 
| String | `"value"` | `"${keyword}"` → `"shoes"` |
| Integer/Long | `123` | `"${count}"` → `42` |
| Float/Double | `1.23` | `"${score}"` → `0.95` |
| Boolean | `true`/`false` | `"${active}"` → `true` |
| List | `["a", "b"]` | `"${tags}"` → `["red", "blue"]` |
| GeoPoint | `[-70.0, 40.0]` | `"${location}"` → `[-70.0, 40.0]` |
| Map | `{"key": "value"}` | Complex nested structures |

## Limitations

- Template queries require at least one search request processor to resolve placeholders
- Query rewriting must occur at the coordinator node (not shard level)
- If a referenced variable is not found, an `IllegalArgumentException` is thrown
- Empty or null template content is not allowed
- Unclosed variable placeholders (missing `}"`) cause parsing errors
- If the rewritten query is invalid, processing effort is wasted

## Change History

- **v2.19.0** (2025-02): Initial implementation of Template Query
  - New `TemplateQueryBuilder` for placeholder-based queries
  - Refactored `QueryRewriteContext` to interface
  - Added `QueryCoordinatorContext` for coordinator-level rewriting
  - Integration with search pipeline processing context

## References

### Documentation
- [Template Query DSL](https://docs.opensearch.org/2.19/query-dsl/specialized/template/)
- [Template Queries Tutorial](https://docs.opensearch.org/2.19/search-plugins/search-relevance/template-query/)
- [ML Inference Search Request Processor](https://docs.opensearch.org/2.19/search-plugins/search-pipelines/ml-inference-search-request/)

### Pull Requests
| Version | PR | Description |
|---------|-----|-------------|
| v2.19.0 | [#16818](https://github.com/opensearch-project/OpenSearch/pull/16818) | Introduce Template query |

### Related Issues
- [#16823](https://github.com/opensearch-project/OpenSearch/issues/16823) - RFC: Introduce Template Query to OpenSearch
- [ml-commons#3054](https://github.com/opensearch-project/ml-commons/issues/3054) - Related ML Commons integration
