---
tags:
  - security-analytics
---
# Security Analytics Bug Fixes

## Summary

OpenSearch v2.19.0 includes multiple bug fixes for Security Analytics, addressing issues with aggregation rule-based detectors, OCSF 1.1 field mappings, threat intelligence source validation, and UI improvements in the dashboards plugin.

## Details

### Aggregation Rule Detector Fixes

Several fixes improve the reliability of detectors using Sigma aggregation rules:

| Fix | Description |
|-----|-------------|
| Duplicate alerts prevention | Fixed duplicate alerts generated by aggregation Sigma rules by setting `fanoutEnabled=false` in chained doc-level findings monitor |
| Trigger condition filtering | Fixed detector to work for trigger conditions filtering on aggregation rules by adding rule ID to tags |
| Execution workflow optimization | Optimized sigma aggregation rule-based detectors execution workflow, filtering alerts from match-all doc-level monitors |

The root cause of duplicate alerts was that doc-level monitors fan out work to different nodes. When matching documents exist on different shards queried by different fan-out nodes, each node created its own alert for the same trigger.

### OCSF 1.1 Field Mapping Fixes

Fixes for Open Cybersecurity Schema Framework (OCSF) 1.1 compatibility with AWS Security Lake:

| Fix | Description |
|-----|-------------|
| WAF field mappings | Removed `[]` from WAF field mappings - static mappings can parse list fields without explicit brackets |
| Field mapping order | Changed to check OCSF 1.1 mappings before OCSF 1.0 to resolve field mapping conflicts |
| Additional field mappings | Added various OCSF 1.1 fields to log type static mappings for better automatic field mapping |

The field mapping order fix resolves a conflict where `actor.user.uid` and `actor.user.uid_alt` mappings differed between OCSF 1.0 and 1.1, causing incorrect mappings when OCSF 1.1 logs were ingested.

### Threat Intelligence Fixes

| Fix | Description |
|-----|-------------|
| Source config validation | Added validation for threat intel source config requiring valid `name`, `type`, `format`, `source`, and `ioc_type` |
| Null value handling | Source configs with null values can still be read and deleted |

### Input Handling

| Fix | Description |
|-----|-------------|
| Unexpected input handling | Added catch for unexpected inputs to prevent crashes |

### Test Stability

| Fix | Description |
|-----|-------------|
| Flaky test refactoring | Added wait times to reduce test flakiness in `AlertsIT.testMultipleAggregationAndDocRules_alertSuccess` |

### Dashboards UI Fixes

| Fix | Description |
|-----|-------------|
| Edit trigger rules display | Fixed selected rules not showing when editing existing detector triggers |
| Rule filter options | Only enabled rules now show as filter options when editing triggers |
| Threat intel checkbox removal | Removed threat intel checkbox from detector creation (deprecated in favor of threat intel platform) |
| Notification preview | Updated preview message functionality when setting notifications in detector alerts |

## Limitations

- Threat intel checkbox is deprecated; users should use the dedicated threat intel platform instead
- OCSF 1.1 field mappings take precedence over OCSF 1.0 when both could apply

## References

### Pull Requests

| PR | Repository | Description |
|----|------------|-------------|
| [#1424](https://github.com/opensearch-project/security-analytics/pull/1424) | security-analytics | Fix duplicate alerts from aggregation Sigma rules |
| [#1423](https://github.com/opensearch-project/security-analytics/pull/1423) | security-analytics | Fix detector trigger conditions for aggregation rules |
| [#1418](https://github.com/opensearch-project/security-analytics/pull/1418) | security-analytics | Optimize sigma aggregation rule detectors execution |
| [#1439](https://github.com/opensearch-project/security-analytics/pull/1439) | security-analytics | OCSF 1.1 field mapping fixes |
| [#1403](https://github.com/opensearch-project/security-analytics/pull/1403) | security-analytics | Add OCSF 1.1 fields to static mappings |
| [#1393](https://github.com/opensearch-project/security-analytics/pull/1393) | security-analytics | Add threat intel source config validation |
| [#1442](https://github.com/opensearch-project/security-analytics/pull/1442) | security-analytics | Add catch for unexpected inputs |
| [#1464](https://github.com/opensearch-project/security-analytics/pull/1464) | security-analytics | Refactor flaky test |
| [#1231](https://github.com/opensearch-project/security-analytics-dashboards-plugin/pull/1231) | security-analytics-dashboards-plugin | Fix edit trigger selected rules display |
| [#1232](https://github.com/opensearch-project/security-analytics-dashboards-plugin/pull/1232) | security-analytics-dashboards-plugin | Remove threat intel checkbox from detector creation |
| [#1241](https://github.com/opensearch-project/security-analytics-dashboards-plugin/pull/1241) | security-analytics-dashboards-plugin | Update notification preview functionality |

### Related PRs

| PR | Repository | Description |
|----|------------|-------------|
| [#758](https://github.com/opensearch-project/common-utils/pull/758) | common-utils | Add should_create_single_alert_for_findings field |
| [#1749](https://github.com/opensearch-project/alerting/pull/1749) | alerting | Alerting support for duplicate alert fix |
