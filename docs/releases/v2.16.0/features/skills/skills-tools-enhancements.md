---
tags:
  - skills
---
# Skills Tools Enhancements

## Summary

OpenSearch 2.16.0 introduces three enhancements to the Skills plugin tools: nested query support for neural search tools, a new cluster setting to control PPL execution, and a new CreateAnomalyDetectorTool for LLM-assisted anomaly detector creation.

## Details

### What's New in v2.16.0

#### 1. Nested Query Support for Neural Search Tools

The `NeuralSparseSearchTool`, `VectorDBTool`, and `RAGTool` now support nested queries through a new `nested_path` parameter. This enables searching within nested document structures using neural search capabilities.

**New Parameter:**

| Parameter | Type | Description |
|-----------|------|-------------|
| `nested_path` | String | Path to the nested field containing embeddings |

**Usage Example:**
```json
{
  "type": "VectorDBTool",
  "parameters": {
    "index": "my_nested_index",
    "embedding_field": "embedding.knn",
    "nested_path": "embedding",
    "model_id": "<model_id>",
    "source_field": ["text"]
  }
}
```

When `nested_path` is specified, the tool wraps the neural query in a nested query with `score_mode: max`:

```json
{
  "query": {
    "nested": {
      "path": "embedding",
      "score_mode": "max",
      "query": {
        "neural": {
          "embedding.knn": {
            "query_text": "search text",
            "model_id": "<model_id>",
            "k": 10
          }
        }
      }
    }
  }
}
```

#### 2. PPL Execution Control Setting

A new cluster setting `plugins.skills.ppl_execution_enabled` controls whether PPL queries generated by the PPLTool are executed against the cluster. This provides administrators with fine-grained control over PPL execution.

| Setting | Type | Default | Description |
|---------|------|---------|-------------|
| `plugins.skills.ppl_execution_enabled` | Boolean | `false` | Controls PPL query execution |

When disabled, the PPLTool returns only the generated PPL query without executing it:
```json
{
  "ppl": "source=my_index | where age > 30 | stats count()"
}
```

When enabled, the tool executes the query and returns both the PPL and results:
```json
{
  "ppl": "source=my_index | where age > 30 | stats count()",
  "executionResult": "..."
}
```

#### 3. CreateAnomalyDetectorTool

A new tool that uses LLM to suggest anomaly detector configurations based on index mappings. Given an index name, it analyzes the field mappings and recommends appropriate category fields, aggregation fields, and aggregation methods.

**Parameters:**

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `model_id` | String | Yes | LLM model ID for inference |
| `model_type` | String | No | Model type: `CLAUDE` (default) or `OPENAI` |

**Input:**

| Parameter | Type | Description |
|-----------|------|-------------|
| `index` | String | Target index name (supports wildcards) |

**Output:**
```json
{
  "index": "http_logs",
  "categoryField": "ip",
  "aggregationField": "response,responseLatency",
  "aggregationMethod": "count,avg",
  "dateFields": "timestamp"
}
```

The tool:
1. Retrieves index mappings
2. Identifies date fields (required for anomaly detection)
3. Filters fields to those supporting aggregation
4. Sends mapping info to LLM for analysis
5. Returns suggested configuration for anomaly detector creation

### Technical Changes

**New Files:**
- `SkillSettings.java` - Plugin settings class
- `ClusterSettingHelper.java` - Utility for cluster settings access
- `CreateAnomalyDetectorTool.java` - New anomaly detector creation tool
- `ToolHelper.java` - Shared utility for field extraction
- `CreateAnomalyDetectorDefaultPrompt.json` - Default prompts for Claude/OpenAI

**Modified Files:**
- `ToolPlugin.java` - Registers new settings and CreateAnomalyDetectorTool
- `PPLTool.java` - Integrates PPL execution setting, refactored field extraction
- `NeuralSparseSearchTool.java` - Added nested_path support
- `VectorDBTool.java` - Added nested_path support

## Limitations

- CreateAnomalyDetectorTool requires a date field in the index mapping
- CreateAnomalyDetectorTool does not support system indices (starting with `.`)
- PPL execution is disabled by default; must be explicitly enabled via cluster setting
- Nested query support requires proper nested field mapping in the index

## References

### Pull Requests
| PR | Description | Related Issue |
|----|-------------|---------------|
| [#350](https://github.com/opensearch-project/skills/pull/350) | Support nested query in neural sparse tool, vectorDB tool and RAG tool | |
| [#344](https://github.com/opensearch-project/skills/pull/344) | Add cluster setting to control PPL execution | |
| [#348](https://github.com/opensearch-project/skills/pull/348) | Add CreateAnomalyDetectorTool | [#337](https://github.com/opensearch-project/skills/issues/337) |
