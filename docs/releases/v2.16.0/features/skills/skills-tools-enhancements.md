---
tags:
  - skills
---
# Skills Tools Enhancements

## Summary

OpenSearch v2.16.0 introduces three significant enhancements to the Skills plugin tools: nested query support for vector search tools, a new cluster setting to control PPL execution, and a new CreateAnomalyDetectorTool for AI-assisted anomaly detector creation.

## Details

### What's New in v2.16.0

#### 1. Nested Query Support for Vector Search Tools

The `NeuralSparseSearchTool`, `VectorDBTool`, and `RAGTool` now support nested queries through a new `nested_path` parameter. This enables vector search on nested field structures, which is essential for documents with complex hierarchical data.

**New Parameter:**

| Parameter | Description | Default |
|-----------|-------------|---------|
| `nested_path` | Path to the nested field containing the embedding | Empty (disabled) |

When `nested_path` is specified, the tools wrap the neural/neural_sparse query in a nested query with `score_mode: max`.

**Usage Example:**
```json
{
  "type": "VectorDBTool",
  "parameters": {
    "index": "my-nested-index",
    "embedding_field": "embedding.knn",
    "nested_path": "embedding",
    "model_id": "<model_id>",
    "source_field": ["text"]
  }
}
```

#### 2. PPL Execution Control Setting

A new cluster setting `plugins.skills.ppl_execution_enabled` controls whether PPL queries generated by the PPLTool are executed against the cluster. This provides administrators with fine-grained control over PPL execution for security and resource management.

**New Setting:**

| Setting | Description | Default |
|---------|-------------|---------|
| `plugins.skills.ppl_execution_enabled` | Controls PPL query execution | `false` |

When disabled, the PPLTool returns only the generated PPL query without executing it. This is useful for:
- Security-sensitive environments where query review is required
- Development/testing scenarios
- Environments where PPL execution should be handled separately

**Configuration:**
```json
PUT _cluster/settings
{
  "persistent": {
    "plugins.skills.ppl_execution_enabled": true
  }
}
```

#### 3. CreateAnomalyDetectorTool

A new tool that helps users create anomaly detectors by analyzing index mappings and using LLM to suggest appropriate configuration parameters.

**How It Works:**
1. Takes an index name as input
2. Retrieves the index mappings
3. Filters fields to those supporting aggregation (numeric and keyword types)
4. Sends mapping information to an LLM model
5. Returns suggested configuration including:
   - Category field (for high-cardinality detection)
   - Aggregation fields (numeric fields to monitor)
   - Aggregation methods (sum, count, avg, min, max)
   - Date fields (for time-based detection)

**Supported Model Types:**
- Claude
- OpenAI

**Usage Example:**
```json
{
  "type": "CreateAnomalyDetectorTool",
  "parameters": {
    "model_id": "<llm_model_id>",
    "model_type": "claude"
  }
}
```

**Output Format:**
```json
{
  "index": "opensearch_dashboards_sample_data_ecommerce",
  "categoryField": "geoip.country_iso_code",
  "aggregationField": "total_quantity,total_unique_products,taxful_total_price",
  "aggregationMethod": "sum,count,sum",
  "dateFields": "customer_birth_date,order_date,products.created_on"
}
```

### Technical Changes

#### New Classes
- `CreateAnomalyDetectorTool`: Main tool implementation
- `SkillSettings`: Plugin settings class for PPL execution control
- `ClusterSettingHelper`: Utility for retrieving cluster settings
- `ToolHelper`: Shared utility for extracting field names and types from mappings

#### Modified Classes
- `NeuralSparseSearchTool`: Added `nested_path` parameter and nested query generation
- `VectorDBTool`: Added `nested_path` parameter and nested query generation
- `RAGTool`: Passes `nested_path` to underlying search tools
- `PPLTool`: Integrated cluster setting check before execution
- `ToolPlugin`: Registered new tool and settings

## Limitations

- CreateAnomalyDetectorTool requires an LLM model (Claude or OpenAI) to be configured
- CreateAnomalyDetectorTool does not support system indexes (indexes starting with `.`)
- The tool requires the index to have at least one date-type field for anomaly detection
- PPL execution setting defaults to `false`, requiring explicit enablement

## References

### Pull Requests
| PR | Description | Related Issue |
|----|-------------|---------------|
| [#350](https://github.com/opensearch-project/skills/pull/350) | Support nested query in neural sparse tool, vectorDB tool and RAG tool | |
| [#344](https://github.com/opensearch-project/skills/pull/344) | Add cluster setting to control PPL execution | |
| [#348](https://github.com/opensearch-project/skills/pull/348) | Add CreateAnomalyDetectorTool | [#337](https://github.com/opensearch-project/skills/issues/337) |
